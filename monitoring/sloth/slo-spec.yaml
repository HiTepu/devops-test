version: "prometheus/v1"
service: "cicd-pipeline"
labels:
  team: "devops"
  tier: "platform"
  owner: "sre-team"

slos:

  # 1. Deployment Availability
  - name: deployment-availability
    objective: 99.9
    description: "Deployments should succeed 99.9% of the time"
    sli:
      events:
        error_query: |
          sum(rate(cicd_deployment_status{status="0"}[5m]))
        total_query: |
          sum(rate(cicd_deployment_status[5m]))
    alerting:
      name: DeploymentAvailability
      labels:
        category: availability
        component: deployment

  # 2. Build Availability
  - name: build-availability
    objective: 99.5
    description: "Builds should succeed 99.5% of the time"
    sli:
      events:
        error_query: |
          sum(rate(cicd_build_status{status="0"}[5m]))
        total_query: |
          sum(rate(cicd_build_status[5m]))
    alerting:
      name: BuildAvailability
      labels:
        category: availability
        component: build

  # 3. Build Latency (error = build > 5 minutes)
  - name: build-latency
    objective: 95
    description: "95% of builds should complete within 5 minutes"
    sli:
      events:
        error_query: |
          sum(rate(cicd_build_duration_seconds_bucket{le="+Inf"}[5m]))
          -
          sum(rate(cicd_build_duration_seconds_bucket{le="300"}[5m]))
        total_query: |
          sum(rate(cicd_build_duration_seconds_bucket{le="+Inf"}[5m]))
    alerting:
      name: BuildLatency
      labels:
        category: latency
        component: build

  # 4. Test Availability
  - name: test-availability
    objective: 99
    description: "Tests should pass 99% of the time"
    sli:
      events:
        error_query: |
          sum(rate(cicd_test_status{status="0"}[5m]))
        total_query: |
          sum(rate(cicd_test_status[5m]))
    alerting:
      name: TestAvailability
      labels:
        category: quality
        component: testing

  # 5. Security Scan Availability
  - name: security-scan-availability
    objective: 99.9
    description: "Security scans should complete successfully 99.9% of the time"
    sli:
      events:
        error_query: |
          sum(rate(cicd_security_scan_status{status="0"}[5m]))
        total_query: |
          sum(rate(cicd_security_scan_status[5m]))
    alerting:
      name: SecurityScanAvailability
      labels:
        category: security
        component: scanning

  # 6. Critical Vulnerabilities (ZERO tolerance)
  - name: critical-vulnerability-rate
    objective: 100
    description: "No builds should contain critical vulnerabilities"
    sli:
      events:
        error_query: |
          sum(rate(cicd_vulnerabilities_total{severity="critical"}[5m]))
        total_query: |
          sum(rate(cicd_build_status[5m]))
    alerting:
      name: CriticalVulnerabilities
      labels:
        category: security
        component: vulnerability

  # 7. Rollback Rate
  - name: rollback-rate
    objective: 98
    description: "Less than 2% of deployments should require rollback"
    sli:
      events:
        error_query: |
          sum(rate(cicd_rollback_total[5m]))
        total_query: |
          sum(rate(cicd_deployment_status[5m]))
    alerting:
      name: HighRollbackRate
      labels:
        category: stability
        component: deployment

  # 8. ArgoCD Sync Availability
  - name: argocd-sync-availability
    objective: 99.9
    description: "ArgoCD syncs should succeed 99.9% of the time"
    sli:
      events:
        error_query: |
          sum(rate(argocd_app_sync_status{phase="Failed"}[5m]))
        total_query: |
          sum(rate(argocd_app_sync_status[5m]))
    alerting:
      name: ArgoCDSyncAvailability
      labels:
        category: gitops
        component: argocd
