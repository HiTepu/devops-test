version: "prometheus/v1"
service: "cicd-pipeline"
labels:
  team: "devops"
  tier: "platform"
  owner: "sre-team"

slos:
  # 1️⃣ Deployment Success Rate
  - name: deployment-availability
    objective: 99.9
    description: Deployments should succeed 99.9% of the time
    sli:
      events:
        error_query: |
          sum(rate(cicd_deployment_status{status="0"}[5m]))
        total_query: |
          sum(rate(cicd_deployment_status[5m]))
    alerting:
      name: DeploymentAvailability
      page_alert:
        labels:
          severity: critical
      ticket_alert:
        labels:
          severity: warning

  # 2️⃣ Build Success Rate
  - name: build-availability
    objective: 99.5
    description: Builds should succeed 99.5% of the time
    sli:
      events:
        error_query: |
          sum(rate(cicd_build_status{status="0"}[5m]))
        total_query: |
          sum(rate(cicd_build_status[5m]))
    alerting:
      name: BuildAvailability
      page_alert:
        labels:
          severity: critical

  # 3️⃣ Build Latency (P95 < 5m)
  - name: build-latency
    objective: 95
    description: 95% of builds complete under 5 minutes
    sli:
      raw:
        error_ratio_query: |
          (
            sum(rate(cicd_build_duration_bucket{le="+Inf"}[5m]))
            -
            sum(rate(cicd_build_duration_bucket{le="300"}[5m]))
          )
          /
          sum(rate(cicd_build_duration_bucket{le="+Inf"}[5m]))
    alerting:
      name: BuildLatency
      page_alert:
        labels:
          severity: warning

  # 4️⃣ Test Success Rate
  - name: test-availability
    objective: 99
    description: Tests should pass 99% of the time
    sli:
      events:
        error_query: |
          sum(rate(cicd_test_status{status="0"}[5m]))
        total_query: |
          sum(rate(cicd_test_status[5m]))
    alerting:
      name: TestAvailability
      ticket_alert:
        labels:
          severity: warning

  # 5️⃣ Security Scan Completion
  - name: security-scan-availability
    objective: 99.9
    description: Security scans should succeed
    sli:
      events:
        error_query: |
          sum(rate(cicd_security_scan_status{status="0"}[5m]))
        total_query: |
          sum(rate(cicd_security_scan_status[5m]))
    alerting:
      name: SecurityScanAvailability
      page_alert:
        labels:
          severity: critical

  # 6️⃣ Zero Critical Vulnerabilities
  - name: critical-vulnerabilities
    objective: 100
    description: No builds with critical vulnerabilities
    sli:
      events:
        error_query: |
          sum(rate(cicd_vulnerabilities_total{severity="critical"}[5m]))
        total_query: |
          sum(rate(cicd_build_status[5m]))
    alerting:
      name: CriticalVulnerabilities
      page_alert:
        labels:
          severity: critical

  # 7️⃣ Rollback Rate
  - name: rollback-rate
    objective: 98
    description: Less than 2% deployments rollback
    sli:
      events:
        error_query: |
          sum(rate(cicd_rollback_total[5m]))
        total_query: |
          sum(rate(cicd_deployment_status[5m]))
    alerting:
      name: RollbackRate
      ticket_alert:
        labels:
          severity: warning
