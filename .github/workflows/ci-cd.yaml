name: CI/CD Pipeline v·ªõi Monitoring & Security

on:
  push:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      skip_error_budget_check:
        description: 'Skip error budget check (emergency only)'
        required: false
        type: boolean
        default: false
      backup_retention_days:
        description: 'Backup retention days'
        required: false
        type: number
        default: 30

permissions:
  contents: write
  security-events: write
  actions: read

env:
  HARBOR_URL: harbor.lmsx.io.vn
  HARBOR_PROJECT: demo
  IMAGE_NAME: nginx
  PROMETHEUS_PUSHGATEWAY: prometheus.lmsx.io.vn
  PROMETHEUS_URL: prometheus.lmsx.io.vn
  GRAFANA_URL: grafana.lmsx.io.vn
  # Error Budget Configuration
  ERROR_BUDGET_THRESHOLD: 10  # Block deployment if error budget < 10%
  ERROR_BUDGET_WINDOW: 30d    # 30 days window
  # Backup Configuration
  BACKUP_RETENTION_DAYS: ${{ github.event.inputs.backup_retention_days || 30 }}
  MAX_BACKUPS_LOCAL: 50       # Maximum local backups to keep

jobs:
  # Job 1: Error Budget Check (CRITICAL - BLOCKS DEPLOYMENT)
  check-error-budget:
    runs-on: ubuntu-latest
    outputs:
      error_budget_remaining: ${{ steps.check.outputs.error_budget }}
      can_deploy: ${{ steps.check.outputs.can_deploy }}
      
    steps:
      - name: Query Error Budget from Prometheus
        id: query
        run: |
          echo "üîç Checking error budget..."
          
          # Query for deployment failures in the last 30 days
          QUERY='(1 - (sum(rate(cicd_deployment_status{status="0",image="'${IMAGE_NAME}'"}['${ERROR_BUDGET_WINDOW}'])) / sum(rate(cicd_deployment_status{image="'${IMAGE_NAME}'"}['${ERROR_BUDGET_WINDOW}'])))) * 100'
          
          # Encode query for URL
          ENCODED_QUERY=$(echo "$QUERY" | jq -sRr @uri)
          
          # Query Prometheus with error handling
          RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" "http://${PROMETHEUS_URL}/api/v1/query?query=${ENCODED_QUERY}")
          
          # Extract HTTP code
          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          BODY=$(echo "$RESPONSE" | sed '/HTTP_CODE:/d')
          
          echo "HTTP Code: $HTTP_CODE"
          echo "Response Body: $BODY"
          
          # Check if Prometheus is accessible
          if [ "$HTTP_CODE" != "200" ] || [ -z "$BODY" ] || echo "$BODY" | grep -q "html"; then
            echo "‚ö†Ô∏è Warning: Cannot query Prometheus (HTTP $HTTP_CODE)"
            echo "This might be the first deployment or Prometheus is not accessible"
            echo "Defaulting to 100% error budget (allowing deployment)"
            ERROR_BUDGET="100"
          else
            # Try to parse JSON response
            if echo "$BODY" | jq empty 2>/dev/null; then
              ERROR_BUDGET=$(echo "$BODY" | jq -r '.data.result[0].value[1] // "100"')
              
              # Validate ERROR_BUDGET is a number
              if ! [[ "$ERROR_BUDGET" =~ ^[0-9]+\.?[0-9]*$ ]]; then
                echo "‚ö†Ô∏è Warning: Invalid error budget value: $ERROR_BUDGET"
                echo "Defaulting to 100%"
                ERROR_BUDGET="100"
              fi
            else
              echo "‚ö†Ô∏è Warning: Invalid JSON response from Prometheus"
              echo "Defaulting to 100% error budget"
              ERROR_BUDGET="100"
            fi
          fi
          
          echo "error_budget=$ERROR_BUDGET" >> $GITHUB_OUTPUT
          echo "üìä Current Error Budget: ${ERROR_BUDGET}%"
      
      - name: Evaluate Error Budget
        id: check
        run: |
          ERROR_BUDGET="${{ steps.query.outputs.error_budget }}"
          THRESHOLD="${ERROR_BUDGET_THRESHOLD}"
          SKIP_CHECK="${{ github.event.inputs.skip_error_budget_check }}"
          
          echo "Error Budget: ${ERROR_BUDGET}%"
          echo "Threshold: ${THRESHOLD}%"
          echo "Skip Check: ${SKIP_CHECK}"
          
          # Convert to integer for comparison
          ERROR_BUDGET_INT=${ERROR_BUDGET%.*}
          
          if [ "$SKIP_CHECK" = "true" ]; then
            echo "‚ö†Ô∏è ERROR BUDGET CHECK SKIPPED (Emergency deployment)"
            echo "can_deploy=true" >> $GITHUB_OUTPUT
            echo "error_budget=$ERROR_BUDGET" >> $GITHUB_OUTPUT
            
            # Send alert metric
            cat <<EOF | curl --data-binary @- ${PROMETHEUS_PUSHGATEWAY}/metrics/job/cicd_emergency/instance/${GITHUB_RUN_ID}
          # HELP cicd_error_budget_check_skipped Error budget check was skipped
          # TYPE cicd_error_budget_check_skipped gauge
          cicd_error_budget_check_skipped{image="${IMAGE_NAME}",branch="${GITHUB_REF_NAME}"} 1
          EOF
            exit 0
          fi
          
          # Validate ERROR_BUDGET_INT is numeric
          if ! [[ "$ERROR_BUDGET_INT" =~ ^[0-9]+$ ]]; then
            echo "‚ö†Ô∏è Warning: Invalid error budget integer: $ERROR_BUDGET_INT"
            echo "Allowing deployment to proceed"
            echo "can_deploy=true" >> $GITHUB_OUTPUT
            echo "error_budget=$ERROR_BUDGET" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if (( ERROR_BUDGET_INT < THRESHOLD )); then
            echo "‚ùå DEPLOYMENT BLOCKED!"
            echo "Error budget (${ERROR_BUDGET}%) is below threshold (${THRESHOLD}%)"
            echo ""
            echo "### ‚ùå Deployment Blocked - Error Budget Exhausted" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Current Error Budget:** ${ERROR_BUDGET}%" >> $GITHUB_STEP_SUMMARY
            echo "**Threshold:** ${THRESHOLD}%" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### üö® Actions Required:" >> $GITHUB_STEP_SUMMARY
            echo "1. Investigate recent deployment failures" >> $GITHUB_STEP_SUMMARY
            echo "2. Fix underlying issues before deploying" >> $GITHUB_STEP_SUMMARY
            echo "3. Monitor [Grafana Dashboard](${GRAFANA_URL}/d/cicd-pipeline)" >> $GITHUB_STEP_SUMMARY
            echo "4. If emergency deployment needed, re-run with 'skip_error_budget_check' option" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### üìä Error Budget Policy:" >> $GITHUB_STEP_SUMMARY
            echo "- Deployments are blocked when error budget < ${THRESHOLD}%" >> $GITHUB_STEP_SUMMARY
            echo "- Focus on stability and bug fixes" >> $GITHUB_STEP_SUMMARY
            echo "- Review [runbook](https://wiki.example.com/error-budget-exhausted)" >> $GITHUB_STEP_SUMMARY
            
            echo "can_deploy=false" >> $GITHUB_OUTPUT
            echo "error_budget=$ERROR_BUDGET" >> $GITHUB_OUTPUT
            
            # Push blocked deployment metric
            cat <<EOF | curl --data-binary @- ${PROMETHEUS_PUSHGATEWAY}/metrics/job/cicd_blocked/instance/${GITHUB_RUN_ID}
          # HELP cicd_deployment_blocked Deployment blocked due to error budget
          # TYPE cicd_deployment_blocked gauge
          cicd_deployment_blocked{image="${IMAGE_NAME}",reason="error_budget",threshold="${THRESHOLD}"} 1
          # HELP cicd_error_budget_remaining Error budget remaining percentage
          # TYPE cicd_error_budget_remaining gauge
          cicd_error_budget_remaining{image="${IMAGE_NAME}"} ${ERROR_BUDGET}
          EOF
            
            exit 1
          else
            echo "‚úÖ Error budget check passed (${ERROR_BUDGET}% remaining)"
            echo "can_deploy=true" >> $GITHUB_OUTPUT
            echo "error_budget=$ERROR_BUDGET" >> $GITHUB_OUTPUT
            
            # Push metric
            cat <<EOF | curl --data-binary @- ${PROMETHEUS_PUSHGATEWAY}/metrics/job/cicd_error_budget/instance/${GITHUB_RUN_ID}
          # HELP cicd_error_budget_remaining Error budget remaining percentage
          # TYPE cicd_error_budget_remaining gauge
          cicd_error_budget_remaining{image="${IMAGE_NAME}"} ${ERROR_BUDGET}
          # HELP cicd_error_budget_check_passed Error budget check passed
          # TYPE cicd_error_budget_check_passed gauge
          cicd_error_budget_check_passed{image="${IMAGE_NAME}"} 1
          EOF
          fi

  # Job 2: Testing
  test:
    runs-on: ubuntu-latest
    needs: check-error-budget
    if: needs.check-error-budget.outputs.can_deploy == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run unit tests
        run: |
          echo "Running unit tests..."
          # npm test ho·∫∑c pytest, go test, etc.
          
      - name: Run integration tests
        run: |
          echo "Running integration tests..."
          # docker-compose -f docker-compose.test.yml up --abort-on-container-exit
      
      - name: Push test metrics to Prometheus
        if: always()
        run: |
          cat <<EOF | curl --data-binary @- ${PROMETHEUS_PUSHGATEWAY}/metrics/job/cicd_tests/instance/${GITHUB_RUN_ID}
          # HELP cicd_test_status Test execution status (1=success, 0=failure)
          # TYPE cicd_test_status gauge
          cicd_test_status{job="unit_tests",branch="${GITHUB_REF_NAME}",repo="${GITHUB_REPOSITORY}"} ${{ job.status == 'success' && '1' || '0' }}
          # HELP cicd_test_duration_seconds Test execution duration
          # TYPE cicd_test_duration_seconds gauge
          cicd_test_duration_seconds{job="unit_tests"} $(echo $SECONDS)
          EOF

  # Job 3: Security Scanning v·ªõi Trivy
  security-scan:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Build image for scanning
        run: |
          docker build -t scan-image:latest .
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'scan-image:latest'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
      
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
      
      - name: Run Trivy for JSON output
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'scan-image:latest'
          format: 'json'
          output: 'trivy-results.json'
      
      - name: Parse and push security metrics
        if: always()
        run: |
          CRITICAL=$(cat trivy-results.json | jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length')
          HIGH=$(cat trivy-results.json | jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length')
          MEDIUM=$(cat trivy-results.json | jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length')
          
          cat <<EOF | curl --data-binary @- ${PROMETHEUS_PUSHGATEWAY}/metrics/job/cicd_security/instance/${GITHUB_RUN_ID}
          # HELP cicd_vulnerabilities_total Total vulnerabilities found
          # TYPE cicd_vulnerabilities_total gauge
          cicd_vulnerabilities_total{severity="critical",image="${IMAGE_NAME}"} ${CRITICAL}
          cicd_vulnerabilities_total{severity="high",image="${IMAGE_NAME}"} ${HIGH}
          cicd_vulnerabilities_total{severity="medium",image="${IMAGE_NAME}"} ${MEDIUM}
          EOF
      
      - name: Check vulnerability threshold
        run: |
          CRITICAL=$(cat trivy-results.json | jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length')
          if [ "$CRITICAL" -gt 0 ]; then
            echo "‚ùå Found $CRITICAL CRITICAL vulnerabilities. Blocking deployment."
            exit 1
          fi

  # Job 4: Advanced Backup Strategy
  backup-strategy:
    runs-on: ubuntu-latest
    needs: [check-error-budget, test, security-scan]
    outputs:
      previous-tag: ${{ steps.backup.outputs.previous_tag }}
      backup-file: ${{ steps.backup.outputs.backup_file }}
      backup-count: ${{ steps.backup.outputs.backup_count }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create comprehensive backup
        id: backup
        run: |
          echo "üì¶ Creating comprehensive backup..."
          
          # Get current deployment info
          CURRENT_IMAGE=$(grep "image:" k8s-manifests/demo/deployment.yaml | head -1 | awk '{print $2}')
          PREVIOUS_TAG=$(echo $CURRENT_IMAGE | cut -d: -f2)
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          
          # Create backup directory structure
          mkdir -p backups/{deployments,configs,metadata}
          
          # 1. Backup deployment manifest
          BACKUP_FILE="backups/deployments/deployment-${TIMESTAMP}-${PREVIOUS_TAG}.yaml"
          cp k8s-manifests/demo/deployment.yaml "$BACKUP_FILE"
          
          # 2. Backup all k8s manifests
          if [ -d "k8s-manifests" ]; then
            tar -czf "backups/configs/k8s-manifests-${TIMESTAMP}.tar.gz" k8s-manifests/
          fi
          
          # 3. Create metadata file
          cat > "backups/metadata/backup-${TIMESTAMP}.json" <<EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "previous_tag": "${PREVIOUS_TAG}",
            "previous_image": "${CURRENT_IMAGE}",
            "git_commit": "${GITHUB_SHA}",
            "git_branch": "${GITHUB_REF_NAME}",
            "workflow_run_id": "${GITHUB_RUN_ID}",
            "workflow_run_number": "${GITHUB_RUN_NUMBER}",
            "actor": "${GITHUB_ACTOR}",
            "error_budget_remaining": "${{ needs.check-error-budget.outputs.error_budget_remaining }}%"
          }
          EOF
          
          # 4. Create rollback script for this specific backup
          cat > "backups/rollback-${TIMESTAMP}.sh" <<'ROLLBACK_SCRIPT'
          #!/bin/bash
          # Auto-generated rollback script
          BACKUP_TAG="PREVIOUS_TAG_PLACEHOLDER"
          BACKUP_FILE="BACKUP_FILE_PLACEHOLDER"
          
          echo "üîÑ Rolling back to version: $BACKUP_TAG"
          
          if [ -f "$BACKUP_FILE" ]; then
            cp "$BACKUP_FILE" k8s-manifests/demo/deployment.yaml
            git add k8s-manifests/demo/deployment.yaml
            git commit -m "‚èÆÔ∏è Rollback to $BACKUP_TAG [skip ci]"
            git push
            echo "‚úÖ Rollback completed"
          else
            echo "‚ùå Backup file not found: $BACKUP_FILE"
            exit 1
          fi
          ROLLBACK_SCRIPT
          
          # Replace placeholders
          sed -i "s|PREVIOUS_TAG_PLACEHOLDER|${PREVIOUS_TAG}|g" "backups/rollback-${TIMESTAMP}.sh"
          sed -i "s|BACKUP_FILE_PLACEHOLDER|${BACKUP_FILE}|g" "backups/rollback-${TIMESTAMP}.sh"
          
          chmod +x "backups/rollback-${TIMESTAMP}.sh"
          
          # 5. Count backups
          BACKUP_COUNT=$(ls -1 backups/deployments/ 2>/dev/null | wc -l)
          
          # 6. Cleanup old backups if exceeds max
          if [ "$BACKUP_COUNT" -gt "$MAX_BACKUPS_LOCAL" ]; then
            echo "üßπ Cleaning up old backups (keeping last ${MAX_BACKUPS_LOCAL})..."
            cd backups/deployments
            ls -t | tail -n +$((MAX_BACKUPS_LOCAL + 1)) | xargs rm -f
            cd ../..
          fi
          
          # Output variables
          echo "previous_tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT
          echo "backup_file=$BACKUP_FILE" >> $GITHUB_OUTPUT
          echo "backup_count=$BACKUP_COUNT" >> $GITHUB_OUTPUT
          
          echo "‚úÖ Backup completed:"
          echo "  - Previous tag: $PREVIOUS_TAG"
          echo "  - Backup file: $BACKUP_FILE"
          echo "  - Total backups: $BACKUP_COUNT"
          
          # Show backup contents
          echo ""
          echo "üìã Backup structure:"
          find backups/ -type f | head -20
      
      - name: Upload backup artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deployment-backup-${{ github.sha }}
          path: backups/
          retention-days: ${{ env.BACKUP_RETENTION_DAYS }}
      
      - name: Commit backups to repository
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add backups/
          
          if ! git diff --staged --quiet; then
            git commit -m "üíæ Backup before deployment to ${{ github.sha }} [skip ci]"
            git push
            echo "‚úÖ Backups committed to repository"
          else
            echo "‚ÑπÔ∏è No new backups to commit"
          fi
      
      - name: Push backup metrics
        run: |
          cat <<EOF | curl --data-binary @- ${PROMETHEUS_PUSHGATEWAY}/metrics/job/cicd_backup/instance/${GITHUB_RUN_ID}
          # HELP cicd_backup_created Backup creation status
          # TYPE cicd_backup_created gauge
          cicd_backup_created{image="${IMAGE_NAME}",previous_tag="${{ steps.backup.outputs.previous_tag }}"} 1
          # HELP cicd_backup_count Total number of backups
          # TYPE cicd_backup_count gauge
          cicd_backup_count{image="${IMAGE_NAME}"} ${{ steps.backup.outputs.backup_count }}
          # HELP cicd_backup_timestamp_seconds Backup creation timestamp
          # TYPE cicd_backup_timestamp_seconds gauge
          cicd_backup_timestamp_seconds{image="${IMAGE_NAME}"} $(date +%s)
          EOF

  # Job 5: Build and Push
  build-and-push:
    runs-on: ubuntu-latest
    needs: [check-error-budget, backup-strategy]
    outputs:
      image-tag: ${{ steps.image-tag.outputs.tag }}
      previous-tag: ${{ needs.backup-strategy.outputs.previous-tag }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Display error budget status
        run: |
          echo "### üìä Error Budget Status" >> $GITHUB_STEP_SUMMARY
          echo "**Remaining:** ${{ needs.check-error-budget.outputs.error_budget_remaining }}%" >> $GITHUB_STEP_SUMMARY
          echo "**Threshold:** ${ERROR_BUDGET_THRESHOLD}%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
      
      - name: Set image tag
        id: image-tag
        run: |
          TAG="${{ github.sha }}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Image tag: $TAG"
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Harbor
        uses: docker/login-action@v3
        with:
          registry: ${{ env.HARBOR_URL }}
          username: ${{ secrets.HARBOR_USERNAME }}
          password: ${{ secrets.HARBOR_PASSWORD }}
      
      - name: Install skopeo
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo
      
      - name: Build image
        run: |
          START_TIME=$(date +%s)
          docker build -t local-image:latest .
          END_TIME=$(date +%s)
          BUILD_DURATION=$((END_TIME - START_TIME))
          echo "BUILD_DURATION=$BUILD_DURATION" >> $GITHUB_ENV
      
      - name: Push with skopeo
        env:
          HARBOR_USER: ${{ secrets.HARBOR_USERNAME }}
          HARBOR_PASS: ${{ secrets.HARBOR_PASSWORD }}
        run: |
          echo "Pushing images..."
          
          skopeo copy \
            --dest-creds="${HARBOR_USER}:${HARBOR_PASS}" \
            docker-daemon:local-image:latest \
            docker://${{ env.HARBOR_URL }}/${{ env.HARBOR_PROJECT }}/${{ env.IMAGE_NAME }}:${{ steps.image-tag.outputs.tag }}
          
          skopeo copy \
            --dest-creds="${HARBOR_USER}:${HARBOR_PASS}" \
            docker-daemon:local-image:latest \
            docker://${{ env.HARBOR_URL }}/${{ env.HARBOR_PROJECT }}/${{ env.IMAGE_NAME }}:latest
          
          echo "‚úÖ Images pushed successfully!"
      
      - name: Push build metrics to Prometheus
        if: always()
        run: |
          cat <<EOF | curl --data-binary @- ${PROMETHEUS_PUSHGATEWAY}/metrics/job/cicd_build/instance/${GITHUB_RUN_ID}
          # HELP cicd_build_status Build status (1=success, 0=failure)
          # TYPE cicd_build_status gauge
          cicd_build_status{image="${IMAGE_NAME}",tag="${{ steps.image-tag.outputs.tag }}",branch="${GITHUB_REF_NAME}"} ${{ job.status == 'success' && '1' || '0' }}
          # HELP cicd_build_duration_seconds Build duration in seconds
          # TYPE cicd_build_duration_seconds gauge
          cicd_build_duration_seconds{image="${IMAGE_NAME}"} ${BUILD_DURATION}
          # HELP cicd_build_timestamp_seconds Build timestamp
          # TYPE cicd_build_timestamp_seconds gauge
          cicd_build_timestamp_seconds{image="${IMAGE_NAME}",tag="${{ steps.image-tag.outputs.tag }}"} $(date +%s)
          EOF
      
      - name: Update Kubernetes manifests
        run: |
          IMAGE_TAG="${{ steps.image-tag.outputs.tag }}"
          IMAGE_FULL="${{ env.HARBOR_URL }}/${{ env.HARBOR_PROJECT }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}"
          
          echo "Updating deployment.yaml with image: $IMAGE_FULL"
          
          sed -i "s|image: harbor.lmsx.io.vn/demo/nginx:.*|image: $IMAGE_FULL|g" k8s-manifests/demo/deployment.yaml
          
          echo "‚úÖ Updated deployment.yaml:"
          grep "image:" k8s-manifests/demo/deployment.yaml
      
      - name: Commit and push manifest changes
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add k8s-manifests/demo/deployment.yaml
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "üöÄ Update image to ${{ steps.image-tag.outputs.tag }} [skip ci]"
            git push
            echo "‚úÖ Manifests updated and pushed to repository"
          fi
      
      - name: Create deployment summary
        run: |
          echo "### üöÄ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### üìä Error Budget" >> $GITHUB_STEP_SUMMARY
          echo "- **Remaining:** ${{ needs.check-error-budget.outputs.error_budget_remaining }}%" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ‚úÖ Sufficient for deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### üê≥ Pushed Images" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.HARBOR_URL }}/${{ env.HARBOR_PROJECT }}/${{ env.IMAGE_NAME }}:${{ steps.image-tag.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.HARBOR_URL }}/${{ env.HARBOR_PROJECT }}/${{ env.IMAGE_NAME }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### üíæ Backup Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Previous version:** \`${{ needs.backup-strategy.outputs.previous-tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Backup file:** \`${{ needs.backup-strategy.outputs.backup-file }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Total backups:** ${{ needs.backup-strategy.outputs.backup-count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Retention:** ${BACKUP_RETENTION_DAYS} days" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### ‚è±Ô∏è Build Metrics" >> $GITHUB_STEP_SUMMARY
          echo "- **Duration:** ${BUILD_DURATION}s" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### üîÑ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- ArgoCD will sync changes within 3 minutes" >> $GITHUB_STEP_SUMMARY
          echo "- Monitor: [Grafana Dashboard](${GRAFANA_URL}/d/cicd-pipeline)" >> $GITHUB_STEP_SUMMARY
          echo "- Rollback if needed: Download backup artifact or use rollback script" >> $GITHUB_STEP_SUMMARY

  # Job 6: Generate SLO Metrics
  slo-metrics:
    runs-on: ubuntu-latest
    needs: build-and-push
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
    
      - name: Install Sloth
        run: |
          VERSION="0.15.0"
          wget https://github.com/slok/sloth/releases/download/v${VERSION}/sloth-linux-amd64
          chmod +x sloth-linux-amd64
          sudo mv sloth-linux-amd64 /usr/local/bin/sloth
          sloth version
    
      - name: Create SLO specification
        run: |
          cat > slo-spec.yaml <<'EOF'
          version: "prometheus/v1"
          service: "nginx"
          labels:
            team: "devops"
            tier: "1"
        
          slos:
            - name: "deployment-success-rate"
              objective: 99.9
              description: "Deployment success rate should be above 99.9%"
              sli:
                raw:
                  error_ratio_query: |
                    sum(rate(cicd_build_status{image="nginx",status="0"}[{{.window}}]))
                    /
                    sum(rate(cicd_build_status{image="nginx"}[{{.window}}]))
              alerting:
                name: DeploymentSuccessRate
                labels:
                  category: "availability"
                annotations:
                  summary: "Deployment success rate is below 99.9%"
                page_alert:
                  labels:
                    severity: "critical"
          
            - name: "build-duration"
              objective: 95
              description: "95% of builds should complete within 5 minutes"
              sli:
                raw:
                  error_ratio_query: |
                    sum(rate(cicd_build_duration_seconds{image="nginx"}[{{.window}}]) > 300)
                    /
                    sum(rate(cicd_build_duration_seconds{image="nginx"}[{{.window}}]) > 0)
              alerting:
                name: BuildDuration
                labels:
                  category: "performance"
          EOF
    
      - name: Generate Prometheus rules
        run: |
          sloth generate -i slo-spec.yaml -o prometheus-slo-rules.yaml
          head -50 prometheus-slo-rules.yaml
     
      - name: Upload SLO rules
        uses: actions/upload-artifact@v4
        with:
          name: prometheus-slo-rules
          path: prometheus-slo-rules.yaml
          retention-days: 30
    
      - name: Push SLO metrics
        run: |
          cat <<EOF | curl --data-binary @- ${PROMETHEUS_PUSHGATEWAY}/metrics/job/cicd_slo/instance/${GITHUB_RUN_ID}
          # HELP cicd_slo_generated SLO rules generation status
          # TYPE cicd_slo_generated gauge
          cicd_slo_generated{service="${IMAGE_NAME}"} 1
          EOF

  # Job 7: Verify Deployment
  verify-deployment:
    runs-on: ubuntu-latest
    needs: build-and-push
    if: always()
    
    steps:
      - name: Wait for ArgoCD sync
        run: |
          echo "Waiting 3 minutes for ArgoCD to sync..."
          sleep 180
      
      - name: Check deployment status
        run: |
          echo "Checking deployment status..."
          # kubectl rollout status deployment/${IMAGE_NAME} -n demo
      
      - name: Push deployment metrics
        if: always()
        run: |
          cat <<EOF | curl --data-binary @- ${PROMETHEUS_PUSHGATEWAY}/metrics/job/cicd_deployment/instance/${GITHUB_RUN_ID}
          # HELP cicd_deployment_status Deployment status (1=success, 0=failure)
          # TYPE cicd_deployment_status gauge
          cicd_deployment_status{image="${IMAGE_NAME}",tag="${{ needs.build-and-push.outputs.image-tag }}",environment="production"} ${{ job.status == 'success' && '1' || '0' }}
          # HELP cicd_deployment_timestamp_seconds Deployment timestamp
          # TYPE cicd_deployment_timestamp_seconds gauge
          cicd_deployment_timestamp_seconds{image="${IMAGE_NAME}"} $(date +%s)
          EOF

  # Job 8: Rollback (manual trigger)
  rollback:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Rollback to previous version
        run: |
          echo "Rolling back to previous version..."
          PREVIOUS_COMMIT=$(git log --grep="Update image to" -n 2 --pretty=format:"%H" | tail -1)
          git checkout $PREVIOUS_COMMIT -- k8s-manifests/demo/deployment.yaml
          
          echo "‚úÖ Rolled back deployment.yaml"
          grep "image:" k8s-manifests/demo/deployment.yaml
      
      - name: Commit rollback
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add k8s-manifests/demo/deployment.yaml
          git commit -m "‚èÆÔ∏è Rollback deployment [skip ci]"
          git push
          
          echo "‚úÖ Rollback completed"
      
      - name: Push rollback metrics
        run: |
          cat <<EOF | curl --data-binary @- ${PROMETHEUS_PUSHGATEWAY}/metrics/job/cicd_rollback/instance/${GITHUB_RUN_ID}
          # HELP cicd_rollback_total Total number of rollbacks
          # TYPE cicd_rollback_total counter
          cicd_rollback_total{image="${IMAGE_NAME}",reason="manual"} 1
          EOF
      
      - name: Notify rollback
        run: |
          echo "### ‚èÆÔ∏è Rollback Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Deployment has been rolled back to previous version" >> $GITHUB_STEP_SUMMARY
          echo "ArgoCD will sync the changes automatically" >> $GITHUB_STEP_SUMMARY
