name: Simple Harbor Test

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Test network connectivity
        run: |
          echo "Testing DNS resolution..."
          nslookup harbor.lmsx.io.vn
          echo "Testing HTTPS connection..."
          curl -v https://harbor.lmsx.io.vn/v2/
      
      - name: Test authentication
        run: |
          echo "Testing login..."
          echo "Harbor12345" | docker login harbor.lmsx.io.vn -u admin --password-stdin
          
          echo "Testing token..."
          TOKEN=$(curl -s -u "admin:Harbor12345" "https://harbor.lmsx.io.vn/service/token?service=harbor-registry&scope=repository:demo/nginx:pull,push" | jq -r '.token')
          echo "Token received: ${TOKEN:0:50}..."
          
          if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
            echo "ERROR: Failed to get token!"
            exit 1
          fi
      
      - name: Manual push test
        run: |
          echo "Pulling nginx..."
          docker pull nginx:alpine
          
          echo "Tagging..."
          docker tag nginx:alpine harbor.lmsx.io.vn/demo/nginx:gh-test
          
          echo "Pushing with verbose output..."
          docker push harbor.lmsx.io.vn/demo/nginx:gh-test -v || docker push harbor.lmsx.io.vn/demo/nginx:gh-test
