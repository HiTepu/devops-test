name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  HARBOR_URL: harbor.lmsx.io.vn
  HARBOR_PROJECT: demo
  IMAGE_NAME: nginx

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Install Harbor Certificate
      - name: Setup Harbor SSL Certificate
        run: |
          echo "Setting up Harbor certificate..."
          
          # Download certificate
          curl -k https://${{ env.HARBOR_URL }}/api/v2.0/systeminfo/getcert -o /tmp/harbor-ca.crt
          
          # Install for system
          sudo cp /tmp/harbor-ca.crt /usr/local/share/ca-certificates/harbor-ca.crt
          sudo update-ca-certificates
          
          # Install for Docker
          sudo mkdir -p /etc/docker/certs.d/${{ env.HARBOR_URL }}
          sudo cp /tmp/harbor-ca.crt /etc/docker/certs.d/${{ env.HARBOR_URL }}/ca.crt
          
          # Verify
          ls -la /etc/docker/certs.d/${{ env.HARBOR_URL }}/
          echo "✅ Harbor certificate installed"
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host
      
      - name: Login to Harbor
        uses: docker/login-action@v3
        with:
          registry: ${{ env.HARBOR_URL }}
          username: ${{ secrets.HARBOR_USERNAME }}
          password: ${{ secrets.HARBOR_PASSWORD }}
      
      - name: Build Docker image
        run: |
          docker build -t ${{ env.HARBOR_URL }}/${{ env.HARBOR_PROJECT }}/${{ env.IMAGE_NAME }}:${{ github.sha }} .
          docker tag ${{ env.HARBOR_URL }}/${{ env.HARBOR_PROJECT }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            ${{ env.HARBOR_URL }}/${{ env.HARBOR_PROJECT }}/${{ env.IMAGE_NAME }}:latest
      
      - name: Push to Harbor
        run: |
          docker push ${{ env.HARBOR_URL }}/${{ env.HARBOR_PROJECT }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ env.HARBOR_URL }}/${{ env.HARBOR_PROJECT }}/${{ env.IMAGE_NAME }}:latest
          echo "✅ Images pushed successfully"
      
      - name: Verify images in Harbor
        run: |
          curl -u "${{ secrets.HARBOR_USERNAME }}:${{ secrets.HARBOR_PASSWORD }}" \
            "https://${{ env.HARBOR_URL }}/api/v2.0/projects/${{ env.HARBOR_PROJECT }}/repositories/${{ env.IMAGE_NAME }}/artifacts" | \
            jq -r '.[].tags[].name' | head -5
